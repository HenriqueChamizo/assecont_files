--LARGURA#200,200,50,200,50#
--TITULO#Dias Trabalhados > 6 por Funcionário - Testar#
DECLARE @DATAINICIAL SMALLDATETIME = %DATAINICIAL%,
        @DATAFINAL SMALLDATETIME = %DATAFINAL%

SELECT A.EMP_NOME AS Empresa, B.EMP_NOME AS Departamento, FUNC_REG AS Registro, FUNC_NOME as Nome, D.Dias
FROM Funcionarios
INNER JOIN Empresas A ON A.EMP_IND = FUNC_EMPRESA
INNER JOIN Empresas B ON B.EMP_IND = DBO.fn_getempresafuncionario(FUNC_IND)
OUTER APPLY(
    SELECT COUNT(*) as Dias FROM Calculo 
        WHERE CAL_TRAB > 0 AND CAL_FUNC = FUNC_IND AND CAL_DATA >= @DATAINICIAL AND CAL_DATA <= @DATAFINAL
) D
WHERE D.Dias > 6
ORDER BY FUNC_NOME